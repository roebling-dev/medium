<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Beginning Swift Programming Part 11 — Grand Central Dispatch and Closures</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Beginning Swift Programming Part 11 — Grand Central Dispatch and Closures</h1>
</header>
<section data-field="subtitle" class="p-summary">
Previously we learned about code structure, readability, and a few more principles.
</section>
<section data-field="body" class="e-content">
<section name="1ba1" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="526b" id="526b" class="graf graf--h3 graf--leading graf--title">Beginning Swift Programming Part 11 — Grand Central Dispatch and Closures</h3><figure name="1aac" id="1aac" class="graf graf--figure graf--startsWithDoubleQuote graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 462px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 66%;"></div><img class="graf-image" data-image-id="0*nCTzBn2gK4pAK-Mn." data-width="5169" data-height="3410" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*nCTzBn2gK4pAK-Mn."></div><figcaption class="imageCaption">“A twin building in a cityscape revealing the urban architecture and the skyline above the skyscrapers” by <a href="https://unsplash.com/@grafuja?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@grafuja?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener" target="_blank">Javier Graterol</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener" target="_blank">Unsplash</a></figcaption></figure><p name="a9ab" id="a9ab" class="graf graf--p graf-after--figure">Previously we learned about code structure, readability, and a few more principles.</p><div name="ff4b" id="ff4b" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/@broebling/beginning-swift-programming-part-10-code-structure-readability-and-principles-c84c30acd0cc" data-href="https://medium.com/@broebling/beginning-swift-programming-part-10-code-structure-readability-and-principles-c84c30acd0cc" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/@broebling/beginning-swift-programming-part-10-code-structure-readability-and-principles-c84c30acd0cc"><strong class="markup--strong markup--mixtapeEmbed-strong">Beginning Swift Programming Part 10 — Code Structure, Readability, and Principles</strong><br><em class="markup--em markup--mixtapeEmbed-em">In the last post, we covered basic protocols, extensions, and subscripting.</em>medium.com</a><a href="https://medium.com/@broebling/beginning-swift-programming-part-10-code-structure-readability-and-principles-c84c30acd0cc" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="f36c120abce69dc4c6d328a0d907aa2d" data-thumbnail-img-id="0*6TT5RBnuyHtUbt9y." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*6TT5RBnuyHtUbt9y.);"></a></div><p name="4eaa" id="4eaa" class="graf graf--p graf-after--mixtapeEmbed">Yes, it wasn’t very technical but if you’ve been honing your skills, your projects have become sizable and you were probably starting to think about ways you can keep your code organized. Code structure between projects varies because developers rarely talk about how to layout code until you’ve started your first job programming. Even then it’s mostly kept quiet and you’re just expected to catch on. This doesn’t do too well if you are trying to write apps on your own.</p><p name="b6f9" id="b6f9" class="graf graf--p graf-after--p">When we covered readability, I didn’t go as far as to talk about everything, but I gave you the basics so when you did come back to your code, you weren’t lost trying to figure out what things were. I could write an entire article on code structure or readability alone, but to keep things moving quickly I skimmed over it. If you’d like to learn more on structure or readability, let me know and I’ll plan out a few in-depth articles after this series is complete.</p><p name="5253" id="5253" class="graf graf--p graf-after--p">Finally, we covered a few principles to give you guidance and a little more context as to why I write code the way I do.</p><p name="1876" id="1876" class="graf graf--p graf-after--p">Let’s get started.</p><h3 name="9919" id="9919" class="graf graf--h3 graf-after--p">Grand Central Dispatch</h3><p name="febe" id="febe" class="graf graf--p graf-after--h3">Grand Central Dispatch is Apple’s way of handling something called dispatch queues. There are three types of queues:</p><ul class="postList"><li name="7fe1" id="7fe1" class="graf graf--li graf-after--p"><em class="markup--em markup--li-em">Serial</em> — perform work sent to a queue in the order they are received, think first in, first out (FIFO). These are also known as <em class="markup--em markup--li-em">private dispatch queues.</em></li><li name="144c" id="144c" class="graf graf--li graf-after--li"><em class="markup--em markup--li-em">Concurrent</em> — perform work sent to a queue at the same time. The order in which each task is started is the same order in which they were added to the queue. The main difference between Serial and Concurrent queues is that in Serial queues, the next task does not start until the first task ends, In Concurrent queues, the next task may not require as much time to complete as the first task and may end before the first task completes. Keep this in mind when deciding on which queue to use. These are also known as <em class="markup--em markup--li-em">global dispatch queues.</em></li><li name="0abd" id="0abd" class="graf graf--li graf-after--li"><em class="markup--em markup--li-em">Main dispatch queue</em> — this is the application’s main thread, or where your application lives. When you put code into <code class="markup--code markup--li-code">viewDidLoad()</code> of a View Controller, this is the queue that does everything.</li></ul><p name="932a" id="932a" class="graf graf--p graf-after--li">I’m going to break away from all of this for a second to give you an idea of how these queues relate to the hardware.</p><figure name="f50e" id="f50e" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 384px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 54.900000000000006%;"></div><img class="graf-image" data-image-id="1*awNlL0Gr8z4iUCnNFQznoA.png" data-width="1366" data-height="750" src="https://cdn-images-1.medium.com/max/800/1*awNlL0Gr8z4iUCnNFQznoA.png"></div></figure><p name="b8b7" id="b8b7" class="graf graf--p graf-after--figure">Here I’ve provided a snapshot of what tasks look like when queued up. I want to cover a couple of definitions before I continue.</p><ul class="postList"><li name="6555" id="6555" class="graf graf--li graf-after--p">Run Loop — Your program doesn’t ever stop until you tell it to, while it’s running it runs under the equivalent of a while loop until it ends. Sometimes it needs to process things, other times it is just a simple pass through the loop with nothing changing.</li><li name="d591" id="d591" class="graf graf--li graf-after--li">Thread — simply stated, these are your individual tasks, if your task requires another task to complete its own procedure it will process this task in another thread. (Not to be confused with CPU Core)</li><li name="2074" id="2074" class="graf graf--li graf-after--li">CPU — the brain of the computer, this is the device that performs computations with one or more cores.</li><li name="7325" id="7325" class="graf graf--li graf-after--li">Core — A Core is a physical or logical piece of the processor that reads your code and returns results. Each core has a number of hardware threads that can be used for the tasks that you send at it.</li><li name="2180" id="2180" class="graf graf--li graf-after--li">CPU Clock Speed — the speed at which the processor reads 1s and 0s(binary). If you’ve ever wondered what 1 GHz means, Giga means billion, so 1 GHz means each core of the processor can read 1 billion ones or zeroes per second. My development computer has a processor speed of 2.8 GHz and has 8 cores. This means it can process 2.8 * 8 = 22.4 billion ones and zeroes per second at its base clock speed. If you were wondering if the clock has anything to do with the run loop, the answer would be yes. The clock performs ticks, each tick is a 1 or a 0 being read in.</li><li name="b8be" id="b8be" class="graf graf--li graf-after--li">Instruction Cycle — sometimes just called cycles and used in the context of talking about CPU Cycles, this is the set of instructions that the CPU reads to perform tasks through a series of ticks.</li></ul><p name="3245" id="3245" class="graf graf--p graf-after--li">Based on the example above, Core 0 is what is in charge of running your app. The main thread is your application. As you can see, I’ve added the run loop to show that is never ending until you tell it to stop by exiting from your application.</p><p name="dde0" id="dde0" class="graf graf--p graf-after--p">As your application runs it may create tasks that need to be performed asynchronously, or at the same time as your app does something else. For this, we create a new thread in another core.</p><p name="50a1" id="50a1" class="graf graf--p graf-after--p">If we send it to a global queue (concurrent) it is placed on the next available core and is processed as soon as it is received.</p><p name="6afc" id="6afc" class="graf graf--p graf-after--p">If we send it to a private queue (serial) it is placed on the next available core and is processed as soon as the core can focus its full attention on the task. This usually happens within a few milliseconds.</p><p name="e473" id="e473" class="graf graf--p graf-after--p">On old systems when you only had one processor, these tasks would run concurrently on the same core, the problem with this is that each task would get interrupted by the system so the system could perform work in between.</p><p name="20a4" id="20a4" class="graf graf--p graf-after--p">On newer systems, this problem still exists, but with up to 8 cores able to perform work, the problem isn’t as apparent.</p><p name="a507" id="a507" class="graf graf--p graf-after--p">Going back to the drawing above, task 1 and task 2 work concurrently on two separate cores, however since we only have 3 cores, any subsequent tasks have to wait for the current task to end.</p><p name="3b6a" id="3b6a" class="graf graf--p graf-after--p">If we were to add another concurrent task to the queue, we may end up with one of the cores switching off between the two tasks which would cause a slow down in the processing of both tasks by a lot. Be aware of how many concurrent tasks you have running.</p><p name="0384" id="0384" class="graf graf--p graf-after--p">Tasks 1 and 3 would be considered to be running serially, task 3 will not start until task 1 has been completed. Task 4 may have been created by task 3 to perform work concurrently that task 3 needed to complete, like downloading data from a server.</p><p name="d7a5" id="d7a5" class="graf graf--p graf-after--p">Task 5 could either have been created serially if task 3 had not yet completed, or it could have been created with either queue if task 3 had ended. Most often when you see this pattern in Xcode Instruments it would be created serially.</p><p name="2447" id="2447" class="graf graf--p graf-after--p">Task 6 could have been created with either queue because it is on its own and all cores are available.</p><p name="9e27" id="9e27" class="graf graf--p graf-after--p">On a much deeper level that will not be covered here, there are optimizations that processors can perform to improve upon the scheduling of tasks even if they are serial or concurrent so my explanation of how these tasks were created may differ from what you see while debugging the performance of your app. This is just a higher level overview of how scheduling works.</p><p name="e830" id="e830" class="graf graf--p graf-after--p">So we’ve talked about what tasks looked like when they are scheduled, but we haven’t talked about how you schedule them on the different queues. First, let’s talk about the different queue priorities (QoS) and then I will show you the code.</p><ol class="postList"><li name="db49" id="db49" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">User Interactive</strong> (Main thread) — the main queue of your application, this is the default when you write logic in your app, it is not a background thread. All User Interface (UI) items are used on this queue when a user taps a button, it performs on the main thread. <em class="markup--em markup--li-em">We want the work placed in the main queue to happen immediately</em>.</li><li name="f0c7" id="f0c7" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">User Initiated</strong> — Your user’s interaction is the most important thing, but sometimes a user makes a request that will take a while. If you perform this work on the main thread, it freezes the UI and the user is stuck. This is bad, instead, we use the user-initiated priority for the task because the user needs this task to return its result as soon as possible. This would be used in-game updates or when a user is retrieving a list of places from a server to load into a map view. <em class="markup--em markup--li-em">Work happens almost immediately</em>.</li><li name="5f4f" id="5f4f" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Default</strong> — This is the default queue that background tasks are assigned to. It takes a lower priority than user-initiated, well, because the user doesn’t need it right now or in the near future to use your app. This is used when a queue priority isn’t provided. <em class="markup--em markup--li-em">Work can be immediate to a few minutes</em>.</li><li name="0c24" id="0c24" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Utility</strong> — This is self-descriptive when you understand what utilities in the programming world are. This is for making network requests for downloading non-critical data, or persisting data to disk. <em class="markup--em markup--li-em">Work takes a few seconds to a few minutes</em>.</li><li name="3737" id="3737" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Background</strong> — This is for the tasks that perform maintenance in your app, things that are important to you but the user is unaware of like indexing. <em class="markup--em markup--li-em">Work can take over a few minutes</em>.</li></ol><p name="98d8" id="98d8" class="graf graf--p graf-after--li">In this order, any task with a higher priority (1 being the highest) can interrupt a task with a lower priority. Make sure you code accordingly. Each task also has a relative priority to its own queue that ranges between 0 and -15 so you get a little bit of scheduling priority within each background queue.</p><figure name="d132" id="d132" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/e7b7491be405a3e5c5daf37c6a2071b5.js"></script></figure><p name="5882" id="5882" class="graf graf--p graf-after--figure">If you want to wait for a background task to finish, there are a few ways you can do this, first is using a dispatch group.</p><p name="4bd2" id="4bd2" class="graf graf--p graf-after--p">A dispatch group contains various background tasks that should all finish before continuing your application, tasks must <code class="markup--code markup--p-code">enter</code> to be a member of the group and <code class="markup--code markup--p-code">leave</code> the dispatch group when they are finished. This allows for multiple background processes to complete before continuing other logic in your program.</p><figure name="8460" id="8460" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/fea37de066b848312afda4c2381c5bb7.js"></script></figure><p name="e859" id="e859" class="graf graf--p graf-after--figure">First, we define a <em class="markup--em markup--p-em">dispatchGroup</em> that we can use to keep track of our downloads. Then we start a download in the user-initiated queue, so it finishes quickly.</p><p name="57c3" id="57c3" class="graf graf--p graf-after--p">Then we start another download in the default queue. This may take a little longer than the user-initiated download but both enter the queue.</p><p name="fb6e" id="fb6e" class="graf graf--p graf-after--p">We then hit <code class="markup--code markup--p-code">dispatchGroup.wait()</code> and the program blocks the main thread until both downloads are complete and both calls to <code class="markup--code markup--p-code">downloadData</code> hit the <code class="markup--code markup--p-code">dispatchGroup.leave()</code> function. This tells <code class="markup--code markup--p-code">dispatchGroup</code> that we have one less item we are waiting on.</p><p name="6e01" id="6e01" class="graf graf--p graf-after--p">Once the second download finishes, the <code class="markup--code markup--p-code">dispatchGroup.wait()</code> is completed and our program continues as normal.</p><p name="feda" id="feda" class="graf graf--p graf-after--p">Another way is to use dispatch semaphores.</p><figure name="4bdb" id="4bdb" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/4e8d09c2b864d7183127148e2632bcdd.js"></script></figure><p name="b40a" id="b40a" class="graf graf--p graf-after--figure">Dispatch semaphores are used with a value of 0 to synchronize a single task, if you have more, you just add the number of tasks that will need to <code class="markup--code markup--p-code">signal</code> the semaphore, or decrement it’s count, before the program will continue. Again the <code class="markup--code markup--p-code">wait()</code> method is used to pause execution. The difference between a dispatch semaphore and a dispatch group is that the group is set as your code enters the group, a semaphore has an initial value and decrements a counter as tasks complete, or as the <code class="markup--code markup--p-code">signal()</code> method is called.</p><p name="1aee" id="1aee" class="graf graf--p graf-after--p">Dispatch sources are also available but will be out of scope for this lesson. If you are interested in learning about these, <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW1" data-href="https://developer.apple.com/library/content/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html#//apple_ref/doc/uid/TP40008091-CH103-SW1" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">see Apple’s documentation</a>.</p><p name="e34a" id="e34a" class="graf graf--p graf-after--p">That about wraps it up with GCD, at least at the level we will look at it. For more information check out Apple’s documentation, <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html" data-href="https://developer.apple.com/library/content/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here (detailed)</a> and <br><a href="https://developer.apple.com/library/content/documentation/Performance/Conceptual/EnergyGuide-iOS/PrioritizeWorkWithQoS.html" data-href="https://developer.apple.com/library/content/documentation/Performance/Conceptual/EnergyGuide-iOS/PrioritizeWorkWithQoS.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here (usage)</a>.</p><figure name="30cf" id="30cf" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 444px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 63.5%;"></div><img class="graf-image" data-image-id="0*gaTjrCXNYdiBVhXG." data-width="5134" data-height="3260" src="https://cdn-images-1.medium.com/max/800/0*gaTjrCXNYdiBVhXG."></div><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@fellowferdi?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@fellowferdi?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener" target="_blank">Ferdinand Stöhr</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener" target="_blank">Unsplash</a></figcaption></figure><h3 name="54e4" id="54e4" class="graf graf--h3 graf-after--figure">Closures</h3><p name="d5b2" id="d5b2" class="graf graf--p graf-after--h3">If you are coming from another language, you already have an idea of what closures are and how you’d use them. They are known in other languages as blocks or lambdas. Closures are used primarily in functional programming, but they have other use cases as well.</p><p name="d09a" id="d09a" class="graf graf--p graf-after--p">The easiest way to describe a closure is by saying <em class="markup--em markup--p-em">a closure is logic that can be passed around in your code as a variable and executed later on in your code</em>.</p><p name="4491" id="4491" class="graf graf--p graf-after--p">The first thing that you should know about closures is that they are reference types.</p><p name="58bc" id="58bc" class="graf graf--p graf-after--p">The second thing you should know is that they are asynchronous most of the time. This means that you should be extra careful to make sure that nothing else changes the closure while you are working with it, and you need to ensure that any long-running closures complete before you try to access their value.</p><p name="7b12" id="7b12" class="graf graf--p graf-after--p">The last thing you should know is closures work by capturing everything used within the closure. This means that if I have a variable set at the top-level of my file and use it within a closure, closure creates a strong reference to the variable. You need to be careful to not own an object that already owns your closure. If <code class="markup--code markup--p-code">ClassA</code> created the closure, the closure should not have a strong reference to <code class="markup--code markup--p-code">ClassA</code>. You can use this by using the <code class="markup--code markup--p-code">weak</code> or <code class="markup--code markup--p-code">unowned</code> keyword, I’ll show you how to do that.</p><p name="ce9a" id="ce9a" class="graf graf--p graf-after--p">First let’s look at closures in their basic form, using a function as a return type:</p><figure name="2ca0" id="2ca0" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/e640f1bd2fe08410990e9c4ee749a281.js"></script></figure><p name="7bea" id="7bea" class="graf graf--p graf-after--figure">Step by step, first we create the function that returns the function inside of it using <code class="markup--code markup--p-code">func applyAddition() -&gt; (Int, Int) -&gt; Int</code>. This reads like I want a function named <code class="markup--code markup--p-code">applyAddition</code> that doesn’t take any parameters <code class="markup--code markup--p-code">()</code> and returns <code class="markup--code markup--p-code">-&gt;</code> a function that is expected to take two input parameters of type Int <code class="markup--code markup--p-code">(Int, Int)</code>. And the function that takes two Ints is expected to return an Int <code class="markup--code markup--p-code">-&gt; Int</code>.</p><p name="9078" id="9078" class="graf graf--p graf-after--p">Next, we define the function that will be returned. <br><code class="markup--code markup--p-code">func add(num1: Int, num2: Int) -&gt; Int</code></p><p name="9414" id="9414" class="graf graf--p graf-after--p">It looks like any other function because it is, the only caveat is that the signature of the function must match the return type signature.</p><pre name="ee2d" id="ee2d" class="graf graf--pre graf-after--p">...  -&gt; (      Int,      Int) -&gt; Int<br>func add(num1: Int,num2: Int) -&gt; Int</pre><p name="57c4" id="57c4" class="graf graf--p graf-after--pre">Then we return <code class="markup--code markup--p-code">add</code> which is the name of the <code class="markup--code markup--p-code">add(num1:num2)</code> function.</p><p name="318f" id="318f" class="graf graf--p graf-after--p">Next, we create a constant to hold our function<br><code class="markup--code markup--p-code">let addValues = applyAddition()<br></code>When we do this, we are essentially saying that <code class="markup--code markup--p-code">addValues</code> should perform the same logic as the function that was returned. So <code class="markup--code markup--p-code">addValues</code> is the same as <code class="markup--code markup--p-code">add</code>.</p><p name="87dc" id="87dc" class="graf graf--p graf-after--p">Because <code class="markup--code markup--p-code">addValues</code> returns a value, we need to provide a variable to hold the return value. In this example, I just called it <code class="markup--code markup--p-code">result</code>. <code class="markup--code markup--p-code">addValues</code> also requires two parameters as defined in the returned <code class="markup--code markup--p-code">addFunction</code> so when we call add values we need to provide two integers to add. <code class="markup--code markup--p-code">addFunction</code> then references back to the block of memory where the <code class="markup--code markup--p-code">add</code> function’s logic resides performs the block of code, then returns the value back to <code class="markup--code markup--p-code">result</code>.</p><p name="b48c" id="b48c" class="graf graf--p graf-after--p graf--trailing">Finally, we print the value of <code class="markup--code markup--p-code">result</code> so we can see that it worked.</p></div></div></section><section name="0bff" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="74ee" id="74ee" class="graf graf--p graf--leading">With closures, we can make the syntax above more succinct.</p><figure name="245e" id="245e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/b1c721e209858867b57e5cfe7d4308d7.js"></script></figure><p name="3f8c" id="3f8c" class="graf graf--p graf-after--figure">Yes, this is the exact same example from above, except we dropped the initial <code class="markup--code markup--p-code">applyAddition</code> function since it didn’t contain any parameters. We could have expanded <code class="markup--code markup--p-code">applyAddition</code> to include parameters that we could check against to return one of the multiple possible functions, but I’ll leave that up to you to discover and explore. It’s not hard, just think about how you could use an if statement in <code class="markup--code markup--p-code">applyAddition</code> to return a different function.</p><p name="177c" id="177c" class="graf graf--p graf-after--p">The way this new example reads is create a constant named <code class="markup--code markup--p-code">addValues</code> that will perform an expression <code class="markup--code markup--p-code">= { ... }</code> that takes two input parameters <code class="markup--code markup--p-code">(num1, num2)</code> and returns an integer <code class="markup--code markup--p-code">-&gt; Int</code>, <code class="markup--code markup--p-code">in</code> the following code.</p><p name="6d0f" id="6d0f" class="graf graf--p graf-after--p">Then we just <code class="markup--code markup--p-code">return num1 + num2</code>. Then we can use <code class="markup--code markup--p-code">addValues</code> to add any values we want without having to write the same code everywhere. This really makes a difference when you make multiple versions.</p><figure name="9dfc" id="9dfc" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/6799e259cfa0dda4f14a04f3da08fdd6.js"></script></figure><p name="8ef9" id="8ef9" class="graf graf--p graf-after--figure">Here we have a function that returns a closure, it takes a single Boolean parameter named <code class="markup--code markup--p-code">isThreePoints</code>. This is what will decide which function we return. The logic in <code class="markup--code markup--p-code">madeGoal</code> checks if we should return a two-point or three-point goal. Then we can take each of those functions and assign them separately to their own variables which we can later call passing in <code class="markup--code markup--p-code">playerScore</code>. Because it returns a value we need to double up and return the value to <code class="markup--code markup--p-code">playerScore</code>. Otherwise <code class="markup--code markup--p-code">playerScore</code> would never get updated.</p><p name="ab85" id="ab85" class="graf graf--p graf-after--p">This is a way to implement your scoring methods in a game. The only thing you need to remember about this is once the game is over, you need to set <code class="markup--code markup--p-code">twoPoints</code> and <code class="markup--code markup--p-code">threePoints</code> to <code class="markup--code markup--p-code">nil</code> to remove the reference in the call to <code class="markup--code markup--p-code">deinit</code>.</p><p name="f220" id="f220" class="graf graf--p graf-after--p">When using closures in classes where the closure relies on a property of the class you need to use <code class="markup--code markup--p-code">{ [unowned propertyName] in ... }</code> in your closure so the class can be deallocated from memory. If you remember back when I <a href="https://medium.com/@broebling/beginning-swift-programming-part-7-initialization-and-de-initialization-overrides-and-reference-4e745ba40d0c" data-href="https://medium.com/@broebling/beginning-swift-programming-part-7-initialization-and-de-initialization-overrides-and-reference-4e745ba40d0c" class="markup--anchor markup--p-anchor" target="_blank">wrote about reference counting</a>, you’ll remember that each reference type has a counter of the number of objects that point to it. An object cannot be released from memory automatically while another object is referencing it.</p><p name="ff02" id="ff02" class="graf graf--p graf-after--p">Using <code class="markup--code markup--p-code">unowned</code> means that we know our closure will not last longer than our class, or in other words, I plan to deallocate this closure before I deallocate the class I’m referencing. If by chance the class is deallocated before our closure is deallocated, our program will crash.</p><p name="3459" id="3459" class="graf graf--p graf-after--p graf--trailing">The way around this is using <code class="markup--code markup--p-code">weak</code>. This means that our closure might last longer than the class property it references, so let’s try this with caution. It provides whatever property was passed in as a weak reference, but as an optional value that we can check if it exists before we actually use it. This gives us a little safety to handle the case where the class was already deinitialized and the property is nil.</p></div></div></section><section name="9dd9" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="e7b2" id="e7b2" class="graf graf--p graf--leading">Trailing closures are used quite often, I’ll show you how they are created, followed by how they live up to their name using URLSession. Due to the length, I’m going to ramp this up a bit and throw a lot of new syntax at you, I’ll explain everything afterward.</p><figure name="9bd1" id="9bd1" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/d35491c37374593add2ae076fe8f14ee.js"></script></figure><p name="0cf3" id="0cf3" class="graf graf--p graf-after--figure">The function declaration provides two parameters, the first is asking for the URL for the request, the second is asking for a function with three parameters of types <code class="markup--code markup--p-code">Data</code>, <code class="markup--code markup--p-code">URLResponse</code>, <code class="markup--code markup--p-code">Error</code> which isn’t expected to return a value. Overall the function returns a <code class="markup--code markup--p-code">URLSessionDataTask</code> that we can use to <code class="markup--code markup--p-code">resume()</code> or <code class="markup--code markup--p-code">pause()</code> the request. Don’t worry about <code class="markup--code markup--p-code">@escaping</code> just yet, I’ll come back to that.</p><p name="c1ec" id="c1ec" class="graf graf--p graf-after--p">Here’s the interesting part. It’s called a trailing closure because since the last parameter of the function takes a function, we are not required to use this syntax:</p><figure name="3add" id="3add" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/18234ce3a9b3e6259e138817b5b109e0.js"></script></figure><p name="8310" id="8310" class="graf graf--p graf-after--figure">Instead, we can use this syntax:</p><figure name="61f3" id="61f3" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/d0d0be28b102fc282562e9903c92e33a.js"></script></figure><p name="2810" id="2810" class="graf graf--p graf-after--figure">So on to the obvious, we basically took out the <code class="markup--code markup--p-code">completionHandler:</code> parameter and instead used the trailing closure syntax after the closing parenthesis of the function parameters.</p><p name="acf3" id="acf3" class="graf graf--p graf-after--p">Let’s take a step back. You saw a couple of new things in the function declaration. The first is <code class="markup--code markup--p-code">@escaping</code>.</p><p name="bb49" id="bb49" class="graf graf--p graf-after--p">When a closure is passed as an argument to a function and the closure is invoked after the function completes, we use an<code class="markup--code markup--p-code">@escaping</code> attribute to state that the closure can escape the function it resides in. For long running tasks, you want this. The counter to this is <code class="markup--code markup--p-code">@noescape</code> which is used by default. When you use <code class="markup--code markup--p-code">@noescape</code>, which is the default attribute, we are telling the compiler that this closure will be invoked before the function completes.</p><p name="58d4" id="58d4" class="graf graf--p graf-after--p">If you don’t know which one to use, just keep it as non-escaping and let Xcode assist you with a warning or error when you need to add the escaping attribute.</p><p name="cdf7" id="cdf7" class="graf graf--p graf-after--p">Next up, Void. Void is simple, it’s just a special type that is the equivalent of returning nothing. When you see void, there is a good chance it was put there for code clarity. In the special case of URLSession, it actually serves a purpose to let the compiler know we are looking for a function that returns nothing and not a tuple of <code class="markup--code markup--p-code">(Data?, URLResponse?, Error?)</code>.</p><h3 name="bef5" id="bef5" class="graf graf--h3 graf-after--p">Summary</h3><p name="1924" id="1924" class="graf graf--p graf-after--h3">I’m sure your head is spinning now. I hope you learned a couple of things about closures and how they can be used in your code. Closures are used often in Swift, you may have determined that various methods assigned to types such as <code class="markup--code markup--p-code">.map</code>, <code class="markup--code markup--p-code">.filter</code>, <code class="markup--code markup--p-code">.sorted</code>,<code class="markup--code markup--p-code">reduced</code>, and <code class="markup--code markup--p-code">deinit</code> are all closures. GCD is full of them and we used them anytime we wanted to push code to a background thread, or to the main thread. They were all trailing syntax closures, some with parameters, some without.</p><p name="11eb" id="11eb" class="graf graf--p graf-after--p">GCD is your best friend while starting off, you’ll only use one thread in your applications when you can distribute the load properly, your app will get a nice boost in performance from the extra cores working to perform various tasks simultaneously.</p><p name="0cb3" id="0cb3" class="graf graf--p graf-after--p">If you are still stuck on closures or would like to learn more, check out Apple’s documentation on closures.</p><div name="3a6d" id="3a6d" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://docs.swift.org/swift-book/LanguageGuide/Closures.html#//apple_ref/doc/uid/TP40014097-CH11-ID94" data-href="https://docs.swift.org/swift-book/LanguageGuide/Closures.html#//apple_ref/doc/uid/TP40014097-CH11-ID94" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://docs.swift.org/swift-book/LanguageGuide/Closures.html#//apple_ref/doc/uid/TP40014097-CH11-ID94"><strong class="markup--strong markup--mixtapeEmbed-strong">Closures - The Swift Programming Language (Swift 4.2)</strong><br><em class="markup--em markup--mixtapeEmbed-em">Note Don&#39;t worry if you are not familiar with the concept of capturing. It is explained in detail below in Capturing…</em>docs.swift.org</a><a href="https://docs.swift.org/swift-book/LanguageGuide/Closures.html#//apple_ref/doc/uid/TP40014097-CH11-ID94" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="78240535d1f3273418509db1b7938926"></a></div><h3 name="31b5" id="31b5" class="graf graf--h3 graf-after--mixtapeEmbed">What’s Next</h3><p name="4a3b" id="4a3b" class="graf graf--p graf-after--h3">You’ll be happy, maybe sad, to know that the hardest part of Swift is closures. Happy to know the rest of this is easy, sad if I failed you and you still are having trouble understanding closures. Don’t worry it’s very common, just Google <code class="markup--code markup--p-code">swift closures</code>, the number of tutorials that come up will tell you everyone struggles with them.</p><p name="d4f5" id="d4f5" class="graf graf--p graf-after--p">So because threw both GCD and Closures at you at once instead of splitting them up, I’m going to go easy in the next lesson and cover some simple things that act more as syntactic sugar as well as a few important differences between <code class="markup--code markup--p-code">Self</code> and <code class="markup--code markup--p-code">self</code>. We will need them moving forward.</p><p name="06a1" id="06a1" class="graf graf--p graf-after--p">Up next is Type Aliases, Property Observers, and Self versus self.</p><p name="a1dd" id="a1dd" class="graf graf--p graf-after--p">I’m thinking it’s going to be a short article but definitely something to make your code cleaner and more functional.</p><p name="ca45" id="ca45" class="graf graf--p graf-after--p">Now I usually say keep practicing, which I will again today. I wouldn’t worry too much about GCD just yet, but I would definitely start practicing with simple closures. I’m not asking you to write escaping closures that download data from some web server, I’m just asking for you to get comfortable with how closures work.</p><p name="e244" id="e244" class="graf graf--p graf-after--p">With that said, keep practicing!</p><div name="5610" id="5610" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/@broebling/beginning-swift-programming-part-12-type-aliases-property-observers-and-self-versus-self-a8c02ce25b29" data-href="https://medium.com/@broebling/beginning-swift-programming-part-12-type-aliases-property-observers-and-self-versus-self-a8c02ce25b29" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/@broebling/beginning-swift-programming-part-12-type-aliases-property-observers-and-self-versus-self-a8c02ce25b29"><strong class="markup--strong markup--mixtapeEmbed-strong">Beginning Swift Programming Part 12 — Type Aliases, Property Observers, and Self versus self</strong><br><em class="markup--em markup--mixtapeEmbed-em">Previously we talked about Grand Central Dispatch and Closures. It was a tough one but you’ll be happy to know that all…</em>medium.com</a><a href="https://medium.com/@broebling/beginning-swift-programming-part-12-type-aliases-property-observers-and-self-versus-self-a8c02ce25b29" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="e55dc254e6140cf89cc3c4febdc0e92a" data-thumbnail-img-id="0*ovxMMHqhF0O_pUiZ." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*ovxMMHqhF0O_pUiZ.);"></a></div><figure name="0cb1" id="0cb1" class="graf graf--figure graf-after--mixtapeEmbed graf--trailing"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 280px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40%;"></div><a href="http://bit.ly/2KkkwGL" data-href="http://bit.ly/2KkkwGL" class="graf-imageAnchor" data-action="image-link" data-action-observe-only="true"rel="noopener"target="_blank"><img class="graf-image" data-image-id="1*5-oC2BqqizoRxIls08WMmA.png" data-width="1250" data-height="500" src="https://cdn-images-1.medium.com/max/800/1*5-oC2BqqizoRxIls08WMmA.png"></a></div></figure></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@broebling" class="p-author h-card">Bob Roebling</a> on <a href="https://medium.com/p/293132b6a69d"><time class="dt-published" datetime="2018-04-15T21:07:23.265Z">April 15, 2018</time></a>.</p><p><a href="https://medium.com/@broebling/beginning-swift-programming-part-11-grand-central-dispatch-and-closures-293132b6a69d" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 1, 2019.</p></footer></article></body></html>