<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Networking in Swift the Right Way</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Networking in Swift the Right Way</h1>
</header>
<section data-field="subtitle" class="p-summary">
A step-by-step guide to correctly retrieve resources
</section>
<section data-field="body" class="e-content">
<section name="086b" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b9d2" id="b9d2" class="graf graf--h3 graf--leading graf--title">Networking in Swift the Right Way</h3><h4 name="5f7d" id="5f7d" class="graf graf--h4 graf-after--h3 graf--subtitle">A step-by-step guide to correctly retrieve resources</h4><figure name="8294" id="8294" class="graf graf--figure graf-after--h4"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 467px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 66.7%;"></div><img class="graf-image" data-image-id="0*Jp3LTM5eUP2OFWtx" data-width="4000" data-height="2669" src="https://cdn-images-1.medium.com/max/800/0*Jp3LTM5eUP2OFWtx"></div><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@rawpixel?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@rawpixel?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener noopener noopener" target="_blank">rawpixel</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener noopener noopener" target="_blank">Unsplash</a></figcaption></figure><p name="27d0" id="27d0" class="graf graf--p graf-after--figure">This piece is a primer in networking that talks about the right way to go about retrieving resources.</p><p name="7bab" id="7bab" class="graf graf--p graf-after--p">I want to split resources into three groups starting at the closest resources to your app which will give you a reference point for the rest of the article.</p><ol class="postList"><li name="a546" id="a546" class="graf graf--li graf-after--p">App Resources — resources included in your app project. They might be located in a <code class="markup--code markup--li-code">.xcassets</code> folder or a generally named resources folder.</li><li name="0b0a" id="0b0a" class="graf graf--li graf-after--li">Local Resources — resources on the device running the app. In iOS, this would be the sandbox for the app; on macOS, this would be every permissible place the app can reach on the computer.</li><li name="9c4f" id="9c4f" class="graf graf--li graf-after--li">Remote Resources — resources that exist somewhere else, such as a website, or another computer in your home.</li></ol><p name="f0c5" id="f0c5" class="graf graf--p graf-after--li">Before the haters come at me about saying website instead of URL or API, I want to mention that URL stands for “Uniform Resource Locator” and exists even for local files and paths. APIs, “Application Programming Interfaces” do not necessarily have to be a remote resource either. An ad blocker might use Safari’s API to block ads.</p><p name="1aad" id="1aad" class="graf graf--p graf-after--p">Enough with the definitions, let’s start with an example that I see quite often:</p><figure name="2b42" id="2b42" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/197aba86511e9cc545eab480411874c3.js"></script></figure><p name="b6d5" id="b6d5" class="graf graf--p graf-after--figure">Ok, so all of this looks good. We first create our <code class="markup--code markup--p-code">imageURL</code> using a URL string. Then because <code class="markup--code markup--p-code">Data:contentsOf</code> can throw an error we surround it in a <code class="markup--code markup--p-code">try/catch</code> statement.</p><p name="86bd" id="86bd" class="graf graf--p graf-after--p">Assuming we didn’t throw an error, we can display the image on the screen. Otherwise, we display an error message to the console.</p><p name="e383" id="e383" class="graf graf--p graf-after--p">This actually works, however, this is considered the wrong way to perform a network call. Why? Let’s refer to the documentation.</p><div name="d485" id="d485" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/foundation/nsdata/1407864-init" data-href="https://developer.apple.com/documentation/foundation/nsdata/1407864-init" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/foundation/nsdata/1407864-init"><strong class="markup--strong markup--mixtapeEmbed-strong">init(contentsOf:options:) — NSData | Apple Developer Documentation</strong><br><em class="markup--em markup--mixtapeEmbed-em">Don’t use this synchronous method to request network-based URLs. For network-based URLs, this method can block the…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/foundation/nsdata/1407864-init" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="8b598770593f7c5f998ba9dc111d7b5f"></a></div><blockquote name="9c76" id="9c76" class="graf graf--blockquote graf-after--mixtapeEmbed">Don’t use this synchronous method to request network-based URLs. For network-based URLs, this method can block the current thread for tens of seconds on a slow network, resulting in a poor user experience, and in iOS, may cause your app to be terminated.</blockquote><p name="74bf" id="74bf" class="graf graf--p graf-after--blockquote">That sounds ominous. Because it’s a synchronous method, meaning it uses the main queue, it can block your main thread. Now you might argue, “But my image is only a few KB in size, it shouldn’t be that big of a deal.” Let me ask, what if you are trying to download that file on a very slow network. What if your phone doesn’t have a great signal.</p><p name="4e5a" id="4e5a" class="graf graf--p graf-after--p">Your UI might be unusable for a second and that is enough time to get a bad review if it happens a lot.</p><p name="31a1" id="31a1" class="graf graf--p graf-after--p">On the opposite end of the spectrum, if this is all you know how to do, what do you do when you are downloading a 50 MB over the same terrible connection? What if that 50 MB is required for you to expose a new level of your game to the user? <code class="markup--code markup--p-code">Data:contentsOf:</code> will not suffice, because as soon as the user ends the app, the data is lost. It doesn’t store partial data and magically resume when your app resumes.</p><p name="fc0b" id="fc0b" class="graf graf--p graf-after--p">This heavy lifting is where the networking libraries of Swift come in.</p><p name="b137" id="b137" class="graf graf--p graf-after--p">Do not allow me to understate <code class="markup--code markup--p-code">Data:contentsOf:</code>, it has its place, and it’s wonderful. This method is meant for Local and App resources only.</p><figure name="7901" id="7901" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/db9ac78e6d2a7f21c693774b01b129a2.js"></script></figure><blockquote name="08d0" id="08d0" class="graf graf--blockquote graf-after--figure"><strong class="markup--strong markup--blockquote-strong">Note:</strong> If you want to get to the local system resources outside of your app, you will need to turn off sandboxing.</blockquote><p name="cb44" id="cb44" class="graf graf--p graf-after--blockquote">If you want to try out the example above, just create a new playground and drop a file in the playground’s resources folder named wishlist.txt with whatever your wishlist is.</p><p name="550a" id="550a" class="graf graf--p graf-after--p">So we talked about local files and that <code class="markup--code markup--p-code">Data:contentsOf</code> is the wrong way to go about remote resources, but what is the right way?</p><p name="68b9" id="68b9" class="graf graf--p graf-after--p">The right way is to use <code class="markup--code markup--p-code">URLSession</code>. <code class="markup--code markup--p-code">URLSession</code> provides a nice library of utilities to help you download your files and keep track of requests. Let’s take a look at a simple implementation using Arthur the cat from above.</p><figure name="269a" id="269a" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/mildocjr/82fa5bf292d88167c2a4ada61ea75dcd.js"></script></figure><p name="fb1f" id="fb1f" class="graf graf--p graf-after--figure">New stuff to cover here. First, we create a session instead of using the default implementation. While I could have just used <code class="markup--code markup--p-code">URLSession.shared.dataTask</code> I opted to create the session. This way I always have the option to customize the connection properties later on. It is my own personal preference.</p><p name="4481" id="4481" class="graf graf--p graf-after--p">For more information on shared sessions see Apple’s documentation.</p><div name="b4b3" id="b4b3" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://developer.apple.com/documentation/foundation/urlsession/1409000-shared" data-href="https://developer.apple.com/documentation/foundation/urlsession/1409000-shared" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://developer.apple.com/documentation/foundation/urlsession/1409000-shared"><strong class="markup--strong markup--mixtapeEmbed-strong">shared — URLSession | Apple Developer Documentation</strong><br><em class="markup--em markup--mixtapeEmbed-em">In general, when working with a shared session, you should avoid customizing the cache, cookie storage, or credential…</em>developer.apple.com</a><a href="https://developer.apple.com/documentation/foundation/urlsession/1409000-shared" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="051b50e498e1fd62d5c12658836fd644"></a></div><p name="e543" id="e543" class="graf graf--p graf-after--mixtapeEmbed">Next, we have to create a task. This task is responsible for downloading the file and handling of the response. The task itself is a closure, but we use trailing closure syntax and pass <code class="markup--code markup--p-code">(data, response, error)</code> to the closure. These are all optional values, and if you use Xcode, the autocompletion will note these are optional. <code class="markup--code markup--p-code">data</code> is the data we expect to receive from the remote location, <code class="markup--code markup--p-code">response</code> is the response header information we receive and <code class="markup--code markup--p-code">error</code> is populated only when an error occurs.</p><p name="fef2" id="fef2" class="graf graf--p graf-after--p">Inside of the closure, we first check if we received an error. The error isn’t related to a client or server error, but a device communication error such as the device being in airplane mode.</p><blockquote name="f1de" id="f1de" class="graf graf--blockquote graf-after--p">If we received a 404 — Page Not found message from the server, the call would still be considered successful by <code class="markup--code markup--blockquote-code"><em class="markup--em markup--blockquote-em">URLSession</em></code> even though the data retrieval was not successful. This is why the error is separate from the response.</blockquote><p name="178c" id="178c" class="graf graf--p graf-after--blockquote">If we didn’t receive an error, then we could continue on, first checking to ensure we received a status code of 200. The <code class="markup--code markup--p-code">URLResponse</code> type does not contain a status code property, however, <code class="markup--code markup--p-code">HTTPURLResponse</code> does. What’s even better is <code class="markup--code markup--p-code">URLResponse</code> can be cast to<code class="markup--code markup--p-code">HTTPURLResponse</code> giving us access to the status code.</p><p name="919f" id="919f" class="graf graf--p graf-after--p">200 — OK is not the only good response code we could check but it’s the most popular. For a full reference, there are resources available. This one is pretty nice.</p><div name="115c" id="115c" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.restapitutorial.com/httpstatuscodes.html" data-href="https://www.restapitutorial.com/httpstatuscodes.html" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.restapitutorial.com/httpstatuscodes.html"><strong class="markup--strong markup--mixtapeEmbed-strong">HTTP Status Codes</strong><br><em class="markup--em markup--mixtapeEmbed-em">HTTP status codes and how to use them in RESTful API or Web Services.</em>www.restapitutorial.com</a><a href="https://www.restapitutorial.com/httpstatuscodes.html" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="13b757b271a2aee3d27b3b1c48e973de"></a></div><p name="e1c1" id="e1c1" class="graf graf--p graf-after--mixtapeEmbed">In our case, we expect to get a status code of 200 back, so it’s the only one we need to check. If we wanted to check more we could make an array of all of the status codes we wanted to check such as:</p><pre name="639f" id="639f" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">let acceptableCodes = [200, 201, 202, 203, 304]</code></pre><p name="148a" id="148a" class="graf graf--p graf-after--pre">Then use the following to check the status:</p><pre name="3a5a" id="3a5a" class="graf graf--pre graf-after--p">if acceptableCodes.contains(httpResponse.statusCode) { ... }</pre><p name="736f" id="736f" class="graf graf--p graf-after--pre">This allows us to add more acceptable codes to our array as needed, simplifying our future changes.</p><p name="1979" id="1979" class="graf graf--p graf-after--p">Finally because <code class="markup--code markup--p-code">data</code> is optional, we need to unwrap <code class="markup--code markup--p-code">data?</code> into something that we can use right away. I unwrapped <code class="markup--code markup--p-code">data</code> into <code class="markup--code markup--p-code">receivedData</code> which gives us non-optional data, and in the off chance where <code class="markup--code markup--p-code">data</code> was still nil, we don’t crash our program.</p><p name="693c" id="693c" class="graf graf--p graf-after--p">With our unwrapped data, we can set the <code class="markup--code markup--p-code">image</code> property of <code class="markup--code markup--p-code">imageView</code> to the a <code class="markup--code markup--p-code">UIImage</code> representation of our <code class="markup--code markup--p-code">receivedData</code>. Because this is UI work we need to do it on the main queue:</p><pre name="7c6e" id="7c6e" class="graf graf--pre graf-after--p">DispatchQueue.main.async {<br>    imageView.image = UIImage(data: receivedData)<br>}</pre><p name="3e2c" id="3e2c" class="graf graf--p graf-after--pre">Easy enough.</p><p name="6556" id="6556" class="graf graf--p graf-after--p">There’s one more thing that needs to be done before all of this even downloads the file.</p><p name="17bd" id="17bd" class="graf graf--p graf-after--p">Remember when we create a task which was responsible for downloading files? That task has a method associated with it called <code class="markup--code markup--p-code">resume()</code>. <code class="markup--code markup--p-code">resume()</code> tells the task to perform this download task. We need to call this method to actually start the download process.</p><p name="635c" id="635c" class="graf graf--p graf-after--p graf--trailing">If it seems cumbersome to do this, think about how much flexibility this provides for your application. You can make your download tasks, then call them at the opportune time, or you can make a download task generic, and use it for multiple calls, reusing the same download task for multiple remote resources.</p></div></div></section><section name="c9b1" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="87cc" id="87cc" class="graf graf--h3 graf--leading">Summary</h3><p name="ab10" id="ab10" class="graf graf--p graf-after--h3">There is a lot more we can expand on when talking about <code class="markup--code markup--p-code">URLSession</code>, but this is just a simple introduction to the right way to download files instead of thinking <code class="markup--code markup--p-code">data:contentsOf:</code> is the way to do it.</p><p name="bfa7" id="bfa7" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">URLSession</code> also offers delegates so you can allow your user to pause, resume, and stop downloads, much like a user would when using Apple Music, the App Store, or even watching videos.</p><p name="b3e4" id="b3e4" class="graf graf--p graf-after--p">There is even a background task option which allows you to continue downloading files, even when the app has been pushed to the background (not when the user force quits the app).</p><p name="2357" id="2357" class="graf graf--p graf-after--p graf--trailing">For quick one-off tests in development (e.g. figuring out what the format of your received JSON will look like), <code class="markup--code markup--p-code">Data:contentsOf:</code> is fine, but for production environments, you should always use <code class="markup--code markup--p-code">URLSession</code> for remote data.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@broebling" class="p-author h-card">Bob Roebling</a> on <a href="https://medium.com/p/17cd34d11b7b"><time class="dt-published" datetime="2018-08-11T17:55:01.408Z">August 11, 2018</time></a>.</p><p><a href="https://medium.com/@broebling/networking-in-swift-the-right-way-17cd34d11b7b" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 1, 2019.</p></footer></article></body></html>